{% load i18n thumbnail rsr_filters %}

{% if projects %}

	<script src="http://maps.google.com/maps/api/js?sensor=false"></script>	
	<script>
		function loadGlobalMap() {
	    	var center = new google.maps.LatLng(0,0);
			var zoom = {{ zoom }};
	        {% for project in projects %}
                {% if project.primary_location.latitude and project.primary_location.longitude %}
                    var project_{{ project.id }}_url = "{% url project_main project_id=project.id %}";
                    var project_{{ project.id }}_latitude = {{ project.primary_location.latitude }};
                    var project_{{ project.id }}_longitude = {{ project.primary_location.longitude }};
                    var project_{{ project.id }}_coordinates = new google.maps.LatLng(project_{{ project.id }}_latitude, project_{{ project.id }}_longitude);
                {% endif %}
	        {% endfor %}			

	        var mapCanvas = document.getElementById('map_canvas');

	        var mapOptions = {
                {% if map_type == 'static' %}
                    draggable: false,
                    disableDefaultUI: true,
                {% endif %}
	            center: center,
	            mapTypeId: google.maps.MapTypeId.ROADMAP,
	            scrollwheel: false,
	            zoom: zoom,
                streetViewControl: false
	        };

            var markerIcon = "{{ marker_icon }}";
            var smallIcon = new google.maps.MarkerImage(markerIcon, null, null, null, new google.maps.Size(10.5,17));
            var normalIcon = new google.maps.MarkerImage(markerIcon);

	        var map = new google.maps.Map(mapCanvas, mapOptions);
			
			
	        {% for project in projects %}
	            var project_{{ project.id }}_marker = new google.maps.Marker({
                    {% if map_type == 'static' %}
                        icon: smallIcon,
                    {% else %}
                        icon: normalIcon,
                    {% endif %}
	                map: map,
	                position: project_{{ project.id }}_coordinates,
	                title: 'Project {{ project.id }}'
	            });

                {% if map_type != 'static' %}
	            var project_{{ project.id }}_info = '<div class="mapInfoWindow">' +
	                '<a href="' + project_{{ project.id }}_url + '">' +
                    '{{ project.name|smart_truncate:35}}</a><br>' +
                    '<a href="' + project_{{ project.id }}_url + '">' +
	                '<img src="{% thumbnail project.current_image 100x100 autocrop sharpen %}" alt="" /></a>' +
					'<p class="small grey" style="margin:0;">{% trans 'Location' %}:' +
					'{{project.primary_location.country.get_continent_display}}, ' +
					'{{project.primary_location.country}}, {{project.primary_location.city}}</p>' +
	                '</div>';
	
	            var project_{{ project.id }}_infowindow = new google.maps.InfoWindow({
	                content: project_{{ project.id }}_info
	            });
	            google.maps.event.addListener(project_{{ project.id }}_marker, 'click', function() {
	                project_{{ project.id }}_infowindow.open(map, project_{{ project.id }}_marker);
	            });
                {% endif %}
	        {% endfor %}

			setCSS();
	    }
		
		function setCSS() {
			
			var css = '#map_canvas {font-size: 12px; font-family:Arial, Helvetica, "Liberation Sans", FreeSans, sans-serif;}';
			css += '.mapInfoWindow { min-height:150px;}';
			
			var head = document.getElementsByTagName('head')[0],
			    style = document.createElement('style'),
			    rules = document.createTextNode(css);

			style.type = 'text/css';
			if(style.styleSheet){
			    style.styleSheet.cssText = rules.nodeValue;
			} else { 
				style.appendChild(rules);
			}
			head.appendChild(style);			
		}
		window.onload = loadGlobalMap;
		
	</script>

	{% if width == 0 and height == 0 %}
    	<div id="map_canvas" style="width: 100%; height: 100%;"></div>
	{% else %}
    	<div id="map_canvas" style="width: {{ width }}px; height: {{ height }}px;"></div>
	{% endif %}
	
{% endif %}
